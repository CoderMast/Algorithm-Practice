package leet823;

import java.util.Arrays;

public class Solution {
    public int numFactoredBinaryTrees(int[] arr) {
        if (arr.length <= 1) {
            return arr.length;
        }

        Arrays.sort(arr);

        long mod = 1000000007;

        // dp 数组的每一个值只记录该位置处的计算值
        long[] dp = new long[arr.length];

        // 状态转移方程如下：
        // left != right : dp = 1 + arr[left] * arr [right] * 2;
        // left == right : dp = 1 + arr[left] * arr [right];

        dp[0] = 1;

        // 当前计算的下标
        int index = 1;
        // 当计算到最后一个时，循环结束
        while (index < arr.length) {
            // 以当前计算的节点为界限，对左半部分赋予左右两个指针
            int left = 0;
            int right = index - 1;

            // 默认情况下，自己作为根节点是可以构成一个满足要求的树，则默认初始化为 1
            long dpCount = 1;

            // 保证左指针一直不超过右指针
            while (left <= right) {
                // 防止计算溢出
                long product = (long) arr[left] * arr[right];

                if (left < right && product == arr[index]) {
                    dpCount += (dp[left] * dp[right]) * 2 % mod;
                    left++;
                } else if (left == right && product == arr[index]) {
                    dpCount += (dp[left] * dp[right]) % mod;
                    left++;
                } else if (product > arr[index]) {
                    right--;
                } else {
                    left++;
                }
            }
            dp[index] = dpCount;
            index++;
        }
        return (int) (Arrays.stream(dp).sum() % mod);
    }

    public static void main(String[] args) {
        Solution s = new Solution();
        int[] arr = {639973773, 696116673, 665364282, 563574, 176991927, 611346247, 824674976, 958661048, 406551412, 359613990, 807082433, 509083882, 552701220, 647173658, 244627910, 373924448, 383386670, 384124460, 735395732, 680094876, 194569873, 993681422, 740151209, 661773786, 338966885, 416267747, 283763421, 49803949, 469044288, 610739166, 644058133, 676870579, 894138612, 116076350, 539079115, 865475480, 514359209, 194505174, 779290522, 337578142, 500565189, 481743554, 958346319, 52322248, 355304280, 878444947, 353258818, 24965320, 474305451, 666283709, 330546379, 178171561, 65305940, 271830224, 969670400, 857505569, 660596376, 598645524, 118019132, 492076935, 418359990, 625276851, 988899040, 951126878, 243497637, 296628754, 856300695, 875082143, 739153153, 882486704, 111987372, 643024712, 207536920, 322582323, 981174199, 948659446, 234335302, 880958871, 918451699, 587789153, 163414229, 253607126, 658503851, 863442744, 412290054, 533649006, 195678413, 964505279, 43190685, 963063834, 771600226, 73023318, 97352194, 92640956, 743971241, 8080348, 502077665, 455160495, 592094422, 858309054, 712274673, 858291423, 938305061, 19451352, 69282834, 945252100, 43292724, 371769564, 851909514, 968521207, 528157636, 205236842, 161672384, 244426553, 898147089, 707379514, 105202766, 946840868, 404013867, 960950027, 780624394, 438112975, 417250269, 927028689, 328260333, 156117678, 748776330, 111080453, 623412578, 785408326, 67185518, 310987548, 445768026, 99160997, 985643008, 882325168, 757870502, 267298185, 916638192, 703792049, 880389271, 329471566, 486847491, 161612543, 971949799, 124438844, 465084350, 151761812, 250102973, 531788261, 951276239, 98866880, 49977464, 693055524, 186136365, 223194520, 526643238, 460157346, 354859345, 233599763, 710724758, 12714706, 205188522, 315147147, 951835737, 411649495, 244918806, 84328943, 286387387, 775847292, 641788591, 843977820, 335032915, 609757418, 760440417, 632779033, 808511619, 253412268, 216152956, 166837540, 27940920, 832660508, 641932436, 920002910, 562936678, 222036415, 469790136, 395259210, 282189301, 904006056, 249982359, 887896986, 333526864, 212331505, 513380061, 714693768, 965800499, 135812506, 835697224, 522607126, 565521744, 400118792, 192378208, 800524908, 1831761, 191683376, 977775661, 206915352, 474912280, 68332914, 716992863, 541320937, 396004169, 975976806, 759238856, 579547153, 336552927, 81517799, 257197070, 113397967, 343329845, 820374685, 394992577, 399391816, 590862216, 856483853, 812435493, 680234594, 342716223, 82923098, 804156744, 978855881, 143117801, 590162140, 894288463, 3072017, 181053880, 363307758, 365884339, 658021986, 495221259, 473252930, 444807895, 262795810, 944085760, 939934251, 557060489, 782859925, 309552274, 137239627, 873934328, 446436782, 94184428, 634484505, 500253600, 35040509, 678491208, 394247299, 535277149, 454891746, 537549288, 833815102, 652914334, 486171619, 287198824, 306346724, 39050905, 163453481, 118987882, 867810594, 410781214, 624020741, 631087071, 585836361, 556469955, 881585577, 346231588, 646379276, 418702385, 558431564, 763253968, 764308805, 515328611, 875392363, 148764442, 741819111, 342278498, 526537864, 561156514, 454425467, 627868197, 647452459, 913674989, 591460985, 800383998, 578935207, 862999831, 967011791, 444808368, 43418294, 64040948, 591567495, 373548421, 643778615, 843913586, 133731208, 48878531, 433699419, 353927624, 753533317, 393424820, 709767971, 576151294, 200857089, 778639112, 456283313, 666063722, 969612229, 986266401, 348413763, 655847124, 540309609, 328118729, 183375267, 454397165, 929553047, 513177212, 624672022, 170194632, 619891362, 428202852, 448804250, 312578019, 143828009, 149007761, 437511302, 683053165, 736803735, 647180617, 856465731, 170745203, 56434685, 176604637, 505596581, 991047495, 251227382, 919339389, 733253987, 14374261, 299931267, 534770740, 592883029, 141512658, 425682802, 323419360, 768860943, 828475567, 16953835, 526297200, 191301742, 19868132, 335450941, 502609985, 987185726, 105170022, 651467227, 277349947, 391632379, 989480117, 194022190, 190060976, 912551988, 285563142, 414710659, 458423435, 711036336, 478068836, 939806414, 873409043, 612632044, 723239037, 50329378, 51163204, 220182873, 228267758, 521582430, 176816890, 546003498, 967167537, 439502563, 754744936, 280961560, 122080086, 173746412, 572942702, 641733999, 512168771, 432607143, 38042021, 822204364, 787926683, 565867196, 984330526, 570400493, 582214163, 520069884, 954786329, 613027213, 728591292, 661150106, 80411516, 556093770, 994205339, 649606660, 191218144, 138963960, 89885437, 137622486, 331362759, 153492, 486335901, 597999622, 789410770, 329572799, 617494798, 63516937, 607764912, 154852321, 993860955, 307450857, 223939992, 986328795, 336416864, 124305001, 289526008, 424181552, 312429599, 32560773, 411863250, 349261208, 605257929, 596430033, 108687637, 75734224, 294016117, 639746147, 999083694, 456201985, 733431275, 83652446, 965429424, 79859751, 341034275, 670564730, 628746910, 574229831, 590956612, 388606267, 337571803, 178382660, 138262112, 517901516, 40013786, 679907597, 997702909, 503556260, 115240772, 570430701, 663701787, 510578763, 765665817, 334833119, 419109261, 751652605, 151372896, 943219311, 301742647, 125703470, 100196400, 842701903, 696079727, 995638167, 954854366, 359736112, 303396878, 233292903, 641445244, 376901972, 307315483, 297205255, 560656072, 771479981, 690950536, 454639007, 964662910, 743626472, 723197485, 330278876, 178930128, 675410100, 676345465, 37300668, 536885911, 523980652, 747444806, 747458754, 538904026, 712474466, 703722789, 84698037, 855642148, 161452515, 995432916, 203585880, 538161211, 499610998, 464046783, 790538306, 852996203, 389329605, 667193768, 294146320, 383550154, 362756799, 538426913, 743097875, 798399310, 503876213, 818971785, 91826772, 432647343, 58668959, 845509827, 122879625, 965264036, 787656264, 149454478, 908486460, 113188928, 259866936, 562373446, 60865064, 53052431, 358298461, 412202002, 331908377, 269183322, 481698510, 573594448, 948063517, 77665181, 610246737, 8076982, 381684026, 376214980, 620147839, 916431458, 761808692, 405898069, 804431854, 412555761, 346976732, 176551595, 673520351, 365759190, 519935652, 384799658, 906981533, 561495304, 214955608, 735763207, 104767376, 253529626, 188295411, 531129778, 409981651, 518055737, 468510401, 817002043, 764036678, 929586376, 511990030, 438635671, 5122923, 538062820, 154806585, 733224818, 547016812, 617565232, 710876704, 189336145, 373209986, 12332977, 485315536, 331406241, 614198169, 416258315, 731716499, 226537274, 158495020, 37497869, 210106122, 71319148, 754466502, 597462014, 424472035, 879421403, 150263376, 140144938, 737094283, 83270151, 903712238, 834144918, 158672960, 55019335, 138207630, 956277542, 610402473, 577846269, 89141185, 169236874, 330413728, 198906860, 493447938, 979702586, 223824055, 772764307, 33439285, 669025028, 330675490, 43944452, 493697401, 984582420, 168446670, 541616518, 466488410, 43971471, 57953638, 962955651, 140443198, 920137107, 528465304, 857214426, 546406018, 298209841, 686194994, 410406243, 488016876, 935741307, 910677658, 123364662, 149719057, 740502986, 794414613, 558891729, 463731119, 281755995, 994389160, 863499933, 977238612, 234257474, 142033906, 180639005, 184039225, 4796054, 414875929, 787925637, 484274733, 271526729, 746668710, 225364097, 10746129, 516567093, 139819493, 417782036, 132616824, 68572367, 558881577, 952130436, 792491297, 996118282, 273498678, 55186160, 678742688, 435826723, 713348950, 429368153, 556278586, 670991318, 777039741, 64974095, 608130851, 494656540, 622804037, 495855628, 14733588, 722087369, 936075122, 962309028, 618972651, 469092895, 491740436, 310932273, 760372243, 583642091, 905581507, 140063016, 758312838, 502483028, 251029640, 41225898, 887880058, 911928011, 717927865, 527418545, 347941127, 468146519, 713616279, 755935122, 200007606, 770385161, 554047942, 544693156, 26634770, 867791781, 910842723, 496411355, 418318005, 876645049, 772200012, 720682281, 998191795, 157712138, 395442477, 727315020, 284472889, 646343358, 16249608, 551207070, 326090731, 783854176, 679418573, 788289057, 613177970, 614656770, 508690751, 697604646, 77205436, 409964118, 566832607, 888969498, 467510613, 312719418, 927655297, 431469452, 900245642, 854694554, 152779919, 85961117, 344380664, 217971066, 775656687, 194592993, 508190773, 593215184, 433922779, 968281740, 894615802, 479633713, 882150534, 83642479, 497477911, 806320175, 659868023, 858917214, 384114714, 504027647, 105396328, 841900350, 987220500, 114061268, 552095388, 552589912, 137991939, 629379788, 56932957, 823247023, 343793173, 723001469, 892938796, 861642496, 475136080, 4435518, 929220048, 833580853, 202533280, 286876243, 242001746, 594174310, 235953838, 401336766, 340618472, 435863278, 948882164, 553904895, 755603193, 976928396, 566691536, 891916499, 573735580, 879743741, 325875688, 517083934, 999079086, 116523658, 857002786, 672714223, 319051570, 849451300, 103942201, 626018374, 313934732, 78794005, 497095788, 395683745, 42371215, 175687785, 980424123, 114177006, 703497033, 39035858, 658532848, 594973536, 670094492, 24400936, 412323711, 621772277, 951884601, 341694336, 256826429, 807026169, 41561684, 878628987, 63264495, 290201627, 803149729, 660571623, 736704879, 928391589, 878438154, 916509292, 918447003, 603399991, 690125377, 971980402, 135190519, 472460629, 215450989, 720136911, 289419679, 336676157, 310241199, 581702072, 752032709, 768875976, 478032558, 340278960, 843379181, 437462016, 793296515, 837171662, 405436639, 448803468, 872192298, 854831415, 82600326, 386606727, 576672290, 855352413, 240782632, 186633625, 255433319, 342077145, 956383089, 473344141, 959591284, 856745619, 379901391, 377867616, 777145265, 99738702, 452951450, 642081170, 752376099, 734284506, 713217087, 2290233, 842014576, 311346322, 499232534, 536131554, 927115295, 230027650, 832495086, 216002836, 762487110, 452614989, 515275182, 609003, 879974198, 948061612, 47411286, 197925182, 167602570, 4269458, 815387051, 290975763, 419897081, 872941364, 647273746, 539681373, 651708240, 843989491, 961072276, 69745969, 965725239, 223131015, 282983874, 512292508, 904732030, 994804024, 46750338, 546053364, 893344270, 264221686, 524151731, 301503175, 508132369, 202344295, 229975802, 959357880, 99536748, 759745399, 114187786, 575479562, 794908060, 842010694, 871821538, 967632108, 74511198, 606434350, 950956162, 515208084, 452341476, 521837549, 582528565, 928046098, 381256570, 24228397, 116245923, 315621558, 56343323, 578488351, 286226015, 805749710, 731754106, 902209265, 29612604, 628737382, 16304817, 794393178, 655519208, 632527674, 471506817, 228981426, 821442505, 224671257, 870625321, 462326203, 719965175, 23426363, 92887393, 665302368, 721668367, 511955244, 377300836, 590344377, 723720321, 632035531, 189636013, 530495752, 476532083, 402254418, 212872914, 896408969, 922265989, 431148480, 757816823, 200774249, 573788994};
        System.out.println(s.numFactoredBinaryTrees(arr));
    }
}
